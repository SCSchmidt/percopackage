---
title: "Percolation analysis of transect data"
author:
  -Schmidt, Sophie C.
  - Author Two
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file

abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

```{r, setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  comment = "#>",
  fig.path = "../figures/"
)


#library(percolatransect) # Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` diretory
```


### Strip excavation in Germany
The second case study is located in Saxony-Anhalt, middle Germany. During the early 2000s the street “Bundesstraße 6” was built near the town of Köthen. The area of the street, approach roads, exits and retention reservoirs were machine test trenched by the Heritage Management to find archaeological sites. Along the ca. 13 km long and mostly 40 m broad part of the street over 6000 features were uncovered (Fahr in prep.), but I will focus on features from the later Bronze Age (group “Saalemündungsgruppe”). For this periods the aim is to find the clusters which delineate a site with the help of percolation analysis. The radius will estimate the distance between features that belong together into one site.

#### Data set 

```{r}
#Data cleaning and prep for Sophie

# load data
BefSchnitt <- read.csv2('source_data/Schnittbefunde4.csv', sep = "\t", dec = ",")

# bringing the periods in the right order
BefSchnitt$epoche <- ordered(BefSchnitt$epoche, levels = c("Neolithikum", "Bronzezeit", "Eisenzeit", "undat."))
BefSchnitt$abschnitt <- ordered(BefSchnitt$abschnitt, levels =c('aelter', 'frueh','mittel', 'spaet'))
BefSchnitt$kultur <- ordered(BefSchnitt$kultur, levels=c("Baalberge", "Bernburg", "Kugelamphorenkultur", "Trichterbecher", "Salzmuende", "Schnurkeramik", "Glockenbecher", "Aunjetitz", "Saalemuendungsgruppe", "sBZ/aeEZ", "Hausurnenkultur"))

# subset settlement features
siedlung_BefSchnitt <- subset(BefSchnitt, BefSchnitt$befundart=='Siedlung')

#Subset the settlement features for relevant cultures
# there are 389 features dated as late bronze age and early iron age, that are being analysed in sBZ as well
siedlung_sBZ_Bef <-subset(siedlung_BefSchnitt, siedlung_BefSchnitt$epoche=='Bronzezeit' & siedlung_BefSchnitt$abschnitt=='spaet')
siedlung_sBZ_Bef <-siedlung_sBZ_Bef[c('PlcIndex', 'Easting', 'Northing')]
write.csv(siedlung_sBZ_Bef, "source_data/BefundesBZ-minimal.csv")

```

There are 1005 settlement features cataloged as belonging to this period.

Because of the test trenching it is assumed, that all features and sites along the transect have been found, even though there are gaps between the actual excavation areas and many features remain undated. Machine trenching has been shown to be the most effective way to find sites [@hey_2006]. Admittedly even then not all sites are discovered, especially Neolithic ones have the least probability to be found, which may be one reason for the small number of Neolithic features in the transect.
The late Bronze age and the early iron age are not easily seperable in the settlements, because the ceramics are very similar. Researchers agree [@wagner_2004, 8 ; @heske_2005, 95] that there seems to be a settlement continuation between the two phases, while the burial practices change. Consequently many features have been dated in both periods. I deal with this by adding the uncertainly dated features to the late bronze age analysis as well.

#### Theoretical Issues
The term “site” has been at the center of a lively debate in survey archaeology over the last 40 years. Until the 70’s it has mostly been defined as a place [@dunnell_1992, 23-24] - a find spot, which is similar to German archaeology, where the term used, “Fundplatz”, means exactly that. In the German archaeological inventories, though, a site may contain several culturally distinct loci “Fundstellen” [@dauber_1950, 96], which are usually cataloged as a settlement, a burial ground, a hoard or as a single find spot of a period [@eggert_2005, 56]. 
Two questions arise, when deciding how to classify a site as a settlement: Qualitatively, what kind of finds or features define a settlement [@linke_1976, 8], and quantitatively, of how far apart two “find spots” are supposed to be. If two sherds of the same time period are found 50 m apart - are these two sites or belong they to one site? In every larger settlement or landscape archaeological study this topic is being discussed and in the end a decision felled, which the authors agree, is kind of arbitrary and should actually rely on empiric studies [@malmer_1962; @mischka_2007]. 
Since the middle of the 1970s there has been the discussion of a non- or off-site approach to anglophone archaeology. The terms were introduced by Thomas [-@thomas_1975] and Foley [-@foley_1981] and describe the analysis of finds "between sites". This approach understands the archaeological record  as a continual distribution in space, with spots of higher densities, the so-called “sites”, and areas of lower density [@wobst_1983, 39].
At this point the continuously excavated data set of the street and the clustering analysis percolation can be fruitfully connected: As percolation works with radii around points it may assist in quantitatively assessing which distances between features are common. 
Assuming a connection between underground features and surface finds enables us to transfer the distances of the features to those of finds and may inform landscape archaeological surveys on the decision on attributing single finds to an already known site or registering a new site. Of course, settlement features only comprise the “build space” of a settlement. Though features in-between sites may exist, like traps or temporary storage facilities, places like working areas or fields which may be detected by off-site surface find distributions, won’t be included.

### Percolation


```{r eval=FALSE, include=FALSE}

## run analysis and save results of every run.

### input in source _file.txt

source_file,map_name,shape_file_name,DTM_file_name
BefundesBZ-minimal.csv, late bronze age features,alle_Schnitt-Fundstellen.shp,


### input in radius_values.txt (stays)

upper_radius,lower_radius,step_value,limit,upper_threshold,lower_threshold,radius_unit
500,2,1, 1000,0,0,1

source("create_nodes_list_d.v4.7.R")
source("clustering_script.v3.6.R")
source("mapping_clusters.v4.12.R")# Fehler in ogrInfo(dsn = dsn, layer = layer, encoding = encoding, use_iconv = use_iconv, : Cannot open data source... weeiiiiird... nochmal auf anderer Maschine testen.

source("cluster_frequency_script.v2.17.R")

```



As this analysis is concerned with a very fine level of detail, the starting point and the step size of the percolation algorithm was chosen to be 1m. The size of a prehistoric village in middle Germany can’t be assumed to be larger than a kilometer in diameter, therefore the largest radius used was 500m.

```{r mean cluster size, eval=FALSE, include=FALSE}
library(ggplot2)
library(ggrepel)
# not included because the mean cluster size ist too different because of hugely different sample sizes

mean_steps <- c(1,1+which(diff(analysis_by_radius$mean_clust_size)!=0))

sBZ_meansteps <- as.data.frame(cbind(analysis_by_radius$radius[mean_steps], analysis_by_radius$mean_clust_size[mean_steps]))

sBZ_meansteps <- subset(sBZ_meansteps, sBZ_meansteps$V1 == 46 | sBZ_meansteps$V1 == 68 | sBZ_meansteps$V1 == 88 |  sBZ_meansteps$V1 == 140 | sBZ_meansteps$V1 == 175 | sBZ_meansteps$V1 == 221 | sBZ_meansteps$V1 == 297 |sBZ_meansteps$V1 == 374)

ggplot()+
  geom_line(data = analysis_by_radius, aes(x = radius, y = mean_clust_size))+
  geom_point(data = sBZ_meansteps, aes(x = sBZ_meansteps$V1, y = sBZ_meansteps$V2))+
  geom_label_repel(aes(x = sBZ_meansteps$V1, y = sBZ_meansteps$V2, label = sBZ_meansteps$V1),
                     box.padding   = 0.35, 
                   point.padding = 0.5,
                   nudge_y = 50,
                  segment.color = "grey50",
                  color = "grey50")+
  theme_light()+
  labs(title = "Sizes of clusters increasing with percolation radius",
         x = "Percolation radius",
       y = "Mean Cluster size")

ggsave("mean_clusters_sBZ.png", height = 10, width =  20, units = "cm", dpi = 600  )

```

There are several levels of clustering. Features of the late Bronze Age create a steep curve in the beginning, which shows a close clustering at low percolation radii. Longer stretches of flattening might be interpreted as the algorithm running out of features to add to the clusters. We thereby find the edges of settlements and can define their size. The step-wise rises at higher percolation radii needs explanation as well. To provide these, the results will be compared to large scale excavations of settlements in middle Germany.

I highlighted those points that mark the most distinctive steps in the distribution. We can see the radii after which the algorithm doesn't change the cluster size for some time, showing that here stretches of space between features exist.
If the dataset is forced to split into two groups the step at  `r sBZ_turn_rmean[2]` radius turns out to be the splitting point of the mean cluster sizes calculated.

```{r mean cluster size turning points, include=FALSE}


# calculate turning points of distance measure vectors
# google terms: knee of curve, "trade off point"
#https://dataplatform.cloud.ibm.com/analytics/notebooks/54d79c2a-f155-40ec-93ec-ed05b58afa39/view?access_token=6d8ec910cf2a1b3901c721fcb94638563cd646fe14400fecbb76cea6aaae2fb1

#https://www.rdocumentation.org/packages/SamSPECTRAL/versions/1.26.0/topics/kneepointDetection


#install.packages("ecp")
library("ecp")

# same late bronze age
turn_sBZ_mean <- e.divisive(as.matrix(diff(analysis_by_radius$mean_clust_size)), k = 1, min.size = nrow(analysis_by_radius)/10) 

sBZ_turn_rmean <-analysis_by_radius$radius[turn_sBZ_mean$estimates]

```



## interpretation

The late bronze age features are mostly concentrated in the western half and on the eastern-most part of the transsect. As can be seen by the rapidly rising graph describing the mean cluster size in relation to the percolation radius, the features cluster closely by each other. First steps in the distribution can be seen at 46 m, 68 m and 88 m. These are the distances, at which the clusters "stabilise" and don't grow with growing percolation radii. 


The largest excavation site of the late bronze age in middle Germany is to be found in Zwenkau(-Eythra) in Saxony, which was excavated in advance of coal mining. At Zwenkau several single farmsteads delimited by houses and fences spread over the whole excavation area, which measures at its greatest dimensions 1100 x 825 m [@huth_1998, 194.213]. The farmsteads in Zwenkau don't overlap [@huth_1998, 214] and the distances to each other are quite diverse. Nonetheless a number of them seem to scatter at at an intervall of ca. 65-75 m. [cf.  @huth_1998, 211, fig. 6]. The farmsteads themselves are not all the same size, but the longest sides show to about 50 - 85m long (cumulating to sizes of 2000 - 2500 m²) [@huth_1998, 213.]. It is assumed not all of them existed at the same time, but that there were always several isolated farmsteads in a scattered distribution to each other [@huth_1998, 214]. 

At the analysed transect excavation we also deal with a depth in time, as there are overlapping features and several ditches, which most probably did not exist at the same time, but can be interpreted as indices of small-scale settlement shifts. 


Damit liegen sie recht nahe beieinander, was, würde hier eine ähnliche Untersuchung durchgeführt werden wie in der vorliegenden Arbeit, zu schlechten Abgrenzungsmöglichkeiten von Siedlungsstätten führen könnte. Auf dem zitierten Plan sind jedoch nur Hausgrundrisse und Zaungräbchen eingezeichnet, was eine Vergleichbarkeit erschwert. Zudem gehen die Bearbeiter davon aus, dass die einzelnen Gehöfte nicht zeitgleich waren, sondern eine Wechselsiedlung bestand, in der stets mehrere Gehöfte in Streulage zueinander standen^[@huth_1998, 214.].

Im Arbeitsgebiet entlang der B6n ist innerhalb der Spätbronzezeit ebenfalls mit einer zeitlichen Tiefe der Befunde zu rechnen^[Belegt durch Befundüberschneidungen z. B. zwischen einem Pfostenbau (Befundnummer 11333) und einer Grube (Befundnummer 11028)]. Im Westen der Trasse (zw. Fpl. 4 und 11) sind zudem vier Gräben aufgedeckt worden. Gräben werden häufig als Siedlungsgrenzen interpretiert. Die Abstände zueinander (720 m, 370 m, 440 m) sowie die Ausrichtungen des westlichsten und östlichsten der Gräben, die beide gegen Osten abzugrenzen scheinen, lassen jedoch vermuten, dass sie nicht gleichzeitig bestanden, sondern ein Zeichen kleinräumiger Verlagerungen darstellen. Die hohe Dichte der Befunde der Spätbronzezeit ist damit sicherlich zum Teil Ergebnis einer ortskonstanten Siedlungsweise^[Wie z.B. der Wechselsiedlung, wie sie für Zwenkau vorgeschlagen wurde (@huth_1998, 208).]. Nichtsdestotrotz zeichnen sich Befundcluster mit einem Radius von 33 m ab, deren Dopplung, 66 m, innerhalb des Bereichs der Größe der Einzelhöfe in Zwenkau liegt. Zwischen Fpl. 4 und 11 liegen neben sehr dichten Clustern sowohl fundleere Bereiche als auch Stellen mit geringerer Befundkonzentration. 

Nach diesen Ergebnissen liegen spätbronzezeitliche Befunde in kleineren Radien (in Analogie zu Zwenkau in Einzelhöfen) eng beieinander, während in der älteren Eisenzeit in größeren Abständen und größeren Zusammenhängen gebaut wurde. In beiden Fällen ist jedoch mit zeitlicher Tiefe zu rechnen und einer schlechten Abgrenzbarkeit von Siedlungsstätten zueinander.  

Es ist jedoch auch vorher schon festgestellt worden „Man hat es [..] in der Jungbronze- und Früheisenzeit mit vielfältigen Besiedlungsformen
zu tun“^[@huth_1998, 216.]. Erschwerend kommt hinzu, dass durch die ungenauen Datierungsmöglichkeiten hier eine sehr tiefe Zeitspanne vorliegt, bei der in jeder Analyse eventuelle chronologische Unterschiede verwischt werden. 

Interessant bleibt es festzuhalten, dass sich durchaus Unterschiede zwischen der Spätbronzezeit und den auch ältereisenzeitlich datierten Befunden fassen lassen. Ob dies ein zufälliger Effekt oder ein Hinweis für Veränderungen im Siedlungsverhalten ist, können nur weitere Untersuchungen klären.

IDee:
Abgleich mit den vom LDA abgegrenzten sites bei welchem cluster-radius??

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

